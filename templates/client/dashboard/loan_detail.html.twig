{% extends 'client/base.html.twig' %}

{% block title %}Détails du Prêt #{{ loan.id }}{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ path('client_dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ path('client_loans') }}">Mes Prêts</a></li>
                        <li class="breadcrumb-item active">Prêt #{{ loan.id }}</li>
                    </ol>
                </nav>
                <h1 class="h3 mb-0">
                    <i class="fas fa-money-bill-wave text-primary me-2"></i>
                    Détails du Prêt #{{ loan.id }}
                </h1>
            </div>
            <div>
                <button class="btn btn-outline-info me-2" id="refreshStatus">
                    <i class="fas fa-sync me-1"></i>Actualiser
                </button>
                <a href="{{ path('client_loans') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Retour
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Status Alert -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-{{ loan.status == 'approved' ? 'success' : (loan.status == 'pending' ? 'warning' : 'danger') }} d-flex align-items-center" id="statusAlert">
            <div class="me-3">
                {% if loan.status == 'approved' %}
                    <i class="fas fa-check-circle fa-2x"></i>
                {% elseif loan.status == 'pending' %}
                    <i class="fas fa-clock fa-2x"></i>
                {% else %}
                    <i class="fas fa-times-circle fa-2x"></i>
                {% endif %}
            </div>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-1">
                    {% if loan.status == 'approved' %}
                        Prêt Approuvé
                    {% elseif loan.status == 'pending' %}
                        Demande en Cours d'Examen
                    {% else %}
                        Demande Rejetée
                    {% endif %}
                </h5>
                <p class="mb-0">
                    {% if loan.status == 'approved' %}
                        Félicitations ! Votre demande de prêt a été approuvée. Les fonds seront disponibles sous peu.
                    {% elseif loan.status == 'pending' %}
                        Votre demande est en cours d'examen par nos équipes. Nous vous tiendrons informé de l'évolution.
                    {% else %}
                        Votre demande de prêt n'a pas pu être approuvée. Vous pouvez contacter nos conseillers pour plus d'informations.
                    {% endif %}
                </p>
            </div>
            <div class="text-end">
                <small class="text-muted">
                    Dernière mise à jour: {{ loan.updatedAt ? loan.updatedAt|date('d/m/Y à H:i') : loan.createdAt|date('d/m/Y à H:i') }}
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Loan Details -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle me-2"></i>Informations du Prêt
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Montant Demandé</label>
                        <div class="h4 text-primary">{{ loan.amount|number_format(0, ',', ' ') }} €</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Durée</label>
                        <div class="h4">{{ loan.duration }} mois</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Taux d'Intérêt</label>
                        <div class="h4 text-info">{{ loan.interestRate }}%</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Mensualité</label>
                        <div class="h4 text-success">
                            {% if loan.monthlyPayment %}
                                {{ loan.monthlyPayment|number_format(2, ',', ' ') }} €
                            {% else %}
                                <span class="text-muted">À calculer</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Objet du Prêt</label>
                        <div>{{ loan.purpose|default('Non spécifié') }}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">Date de Demande</label>
                        <div>{{ loan.createdAt|date('d/m/Y à H:i') }}</div>
                    </div>
                </div>

                {% if loan.description %}
                    <div class="mt-3">
                        <label class="form-label fw-bold text-muted">Description</label>
                        <div class="border rounded p-3 bg-light">
                            {{ loan.description|nl2br }}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment Schedule (if approved) -->
        {% if loan.status == 'approved' and loan.monthlyPayment %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calendar-alt me-2"></i>Échéancier de Remboursement
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Mois</th>
                                    <th>Date d'Échéance</th>
                                    <th>Mensualité</th>
                                    <th>Capital</th>
                                    <th>Intérêts</th>
                                    <th>Capital Restant</th>
                                </tr>
                            </thead>
                            <tbody id="paymentSchedule">
                                <!-- Payment schedule will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status Timeline -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history me-2"></i>Suivi de la Demande
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item {{ loan.createdAt ? 'completed' : '' }}">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Demande Soumise</h6>
                            <small class="text-muted">{{ loan.createdAt|date('d/m/Y à H:i') }}</small>
                        </div>
                    </div>
                    
                    <div class="timeline-item {{ loan.status in ['pending', 'approved', 'rejected'] ? 'completed' : '' }}">
                        <div class="timeline-marker {{ loan.status in ['pending', 'approved', 'rejected'] ? 'bg-info' : 'bg-light' }}"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Examen en Cours</h6>
                            <small class="text-muted">
                                {% if loan.status in ['pending', 'approved', 'rejected'] %}
                                    Analysé par nos équipes
                                {% else %}
                                    En attente
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="timeline-item {{ loan.status == 'approved' ? 'completed' : (loan.status == 'rejected' ? 'rejected' : '') }}">
                        <div class="timeline-marker {{ loan.status == 'approved' ? 'bg-success' : (loan.status == 'rejected' ? 'bg-danger' : 'bg-light') }}"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">
                                {% if loan.status == 'approved' %}
                                    Prêt Approuvé
                                {% elseif loan.status == 'rejected' %}
                                    Demande Rejetée
                                {% else %}
                                    Décision Finale
                                {% endif %}
                            </h6>
                            <small class="text-muted">
                                {% if loan.status == 'approved' %}
                                    {{ loan.updatedAt|date('d/m/Y à H:i') }}
                                {% elseif loan.status == 'rejected' %}
                                    {{ loan.updatedAt|date('d/m/Y à H:i') }}
                                {% else %}
                                    En attente de décision
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    {% if loan.status == 'approved' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Déblocage des Fonds</h6>
                                <small class="text-muted">Sous 48-72h ouvrées</small>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>Actions Rapides
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if loan.status == 'pending' %}
                        <button class="btn btn-warning" disabled>
                            <i class="fas fa-edit me-2"></i>Modifier la Demande
                        </button>
                    {% endif %}
                    
                    <a href="{{ path('client_messages') }}" class="btn btn-primary">
                        <i class="fas fa-envelope me-2"></i>Contacter un Conseiller
                    </a>
                    
                    {% if loan.status == 'approved' %}
                        <button class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Télécharger le Contrat
                        </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-secondary">
                        <i class="fas fa-print me-2"></i>Imprimer les Détails
                    </button>
                </div>
            </div>
        </div>

        <!-- Loan Summary -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>Résumé Financier
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <div class="border-bottom pb-2">
                            <div class="text-muted small">Montant Total à Rembourser</div>
                            <div class="h5 mb-0 text-primary">
                                {% if loan.monthlyPayment %}
                                    {{ (loan.monthlyPayment * loan.duration)|number_format(2, ',', ' ') }} €
                                {% else %}
                                    <span class="text-muted">À calculer</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="border-bottom pb-2">
                            <div class="text-muted small">Coût Total du Crédit</div>
                            <div class="h6 mb-0 text-info">
                                {% if loan.monthlyPayment %}
                                    {{ ((loan.monthlyPayment * loan.duration) - loan.amount)|number_format(2, ',', ' ') }} €
                                {% else %}
                                    <span class="text-muted">À calculer</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="text-muted small">TAEG</div>
                        <div class="h6 mb-0 text-warning">{{ loan.interestRate }}%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loanId = {{ loan.id }};
            
            // Real-time status updates
            function updateLoanStatus() {
                const refreshBtn = document.getElementById('refreshStatus');
                const icon = refreshBtn.querySelector('i');
                
                icon.classList.add('fa-spin');
                
                fetch(`{{ path('api_loan_status', {id: loan.id}) }}`)
                    .then(response => response.json())
                    .then(data => {
                        // Update status alert
                        const statusAlert = document.getElementById('statusAlert');
                        let alertClass = 'alert-warning';
                        let iconClass = 'fas fa-clock fa-2x';
                        let title = 'Demande en Cours d\'Examen';
                        let message = 'Votre demande est en cours d\'examen par nos équipes.';
                        
                        if (data.status === 'approved') {
                            alertClass = 'alert-success';
                            iconClass = 'fas fa-check-circle fa-2x';
                            title = 'Prêt Approuvé';
                            message = 'Félicitations ! Votre demande de prêt a été approuvée.';
                        } else if (data.status === 'rejected') {
                            alertClass = 'alert-danger';
                            iconClass = 'fas fa-times-circle fa-2x';
                            title = 'Demande Rejetée';
                            message = 'Votre demande de prêt n\'a pas pu être approuvée.';
                        }
                        
                        statusAlert.className = `alert ${alertClass} d-flex align-items-center`;
                        statusAlert.querySelector('i').className = iconClass;
                        statusAlert.querySelector('.alert-heading').textContent = title;
                        statusAlert.querySelector('p').textContent = message;
                        
                        // Update timeline
                        updateTimeline(data.status);
                        
                        showNotification('Statut mis à jour', `Le statut de votre prêt a été actualisé`, 'info');
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Impossible de mettre à jour le statut', 'danger');
                    })
                    .finally(() => {
                        icon.classList.remove('fa-spin');
                    });
            }
            
            // Update timeline based on status
            function updateTimeline(status) {
                const timelineItems = document.querySelectorAll('.timeline-item');
                
                // Reset all items
                timelineItems.forEach(item => {
                    item.classList.remove('completed', 'rejected');
                    const marker = item.querySelector('.timeline-marker');
                    marker.className = 'timeline-marker bg-light';
                });
                
                // Update based on status
                if (status === 'approved') {
                    timelineItems[0].classList.add('completed');
                    timelineItems[0].querySelector('.timeline-marker').className = 'timeline-marker bg-primary';
                    timelineItems[1].classList.add('completed');
                    timelineItems[1].querySelector('.timeline-marker').className = 'timeline-marker bg-info';
                    timelineItems[2].classList.add('completed');
                    timelineItems[2].querySelector('.timeline-marker').className = 'timeline-marker bg-success';
                } else if (status === 'rejected') {
                    timelineItems[0].classList.add('completed');
                    timelineItems[0].querySelector('.timeline-marker').className = 'timeline-marker bg-primary';
                    timelineItems[1].classList.add('completed');
                    timelineItems[1].querySelector('.timeline-marker').className = 'timeline-marker bg-info';
                    timelineItems[2].classList.add('rejected');
                    timelineItems[2].querySelector('.timeline-marker').className = 'timeline-marker bg-danger';
                } else {
                    timelineItems[0].classList.add('completed');
                    timelineItems[0].querySelector('.timeline-marker').className = 'timeline-marker bg-primary';
                    timelineItems[1].classList.add('completed');
                    timelineItems[1].querySelector('.timeline-marker').className = 'timeline-marker bg-info';
                }
            }
            
            // Refresh button
            document.getElementById('refreshStatus').addEventListener('click', updateLoanStatus);
            
            // Auto-refresh every 2 minutes
            setInterval(updateLoanStatus, 120000);
            
            // Generate payment schedule if loan is approved
            {% if loan.status == 'approved' and loan.monthlyPayment %}
                generatePaymentSchedule();
            {% endif %}
        });

        // Generate payment schedule
        function generatePaymentSchedule() {
            const amount = {{ loan.amount }};
            const monthlyPayment = {{ loan.monthlyPayment }};
            const duration = {{ loan.duration }};
            const interestRate = {{ loan.interestRate }} / 100 / 12;
            
            const tbody = document.getElementById('paymentSchedule');
            let remainingCapital = amount;
            const startDate = new Date('{{ loan.createdAt|date('Y-m-d') }}');
            
            for (let month = 1; month <= duration; month++) {
                const interestPayment = remainingCapital * interestRate;
                const capitalPayment = monthlyPayment - interestPayment;
                remainingCapital -= capitalPayment;
                
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + month);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${paymentDate.toLocaleDateString('fr-FR')}</td>
                    <td class="fw-bold">${monthlyPayment.toFixed(2).replace('.', ',')} €</td>
                    <td class="text-success">${capitalPayment.toFixed(2).replace('.', ',')} €</td>
                    <td class="text-info">${interestPayment.toFixed(2).replace('.', ',')} €</td>
                    <td class="text-primary">${Math.max(0, remainingCapital).toFixed(2).replace('.', ',')} €</td>
                `;
            }
        }
    </script>

    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -23px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        
        .timeline-item.completed .timeline-marker {
            box-shadow: 0 0 0 2px #28a745;
        }
        
        .timeline-item.rejected .timeline-marker {
            box-shadow: 0 0 0 2px #dc3545;
        }
        
        .border-left-primary {
            border-left: 0.25rem solid #007bff !important;
        }
        
        .border-left-success {
            border-left: 0.25rem solid #28a745 !important;
        }
        
        .border-left-warning {
            border-left: 0.25rem solid #ffc107 !important;
        }
        
        .border-left-info {
            border-left: 0.25rem solid #17a2b8 !important;
        }
    </style>
{% endblock %}