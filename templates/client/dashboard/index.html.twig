{% extends 'client/base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt text-primary me-2"></i>
                Bienvenue, {{ user.firstName }} !
            </h1>
            <div class="text-muted">
                <i class="fas fa-clock me-1"></i>
                {{ "now"|date("d/m/Y H:i") }}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total des Prêts
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_loans }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-list fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Prêts Approuvés
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.approved_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            En Attente
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.pending_count }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Montant Total
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.total_amount|number_format(0, ',', ' ') }} €
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-euro-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Loans -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-money-bill-wave me-2"></i>Mes Prêts Récents
                </h6>
                <a href="{{ path('client_loans') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye me-1"></i>Voir tout
                </a>
            </div>
            <div class="card-body">
                {% if loans|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Durée</th>
                                    <th>Taux</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loan in loans|slice(0, 5) %}
                                    <tr data-loan-id="{{ loan.id }}">
                                        <td>{{ loan.createdAt|date('d/m/Y') }}</td>
                                        <td class="fw-bold">{{ loan.amount|number_format(0, ',', ' ') }} €</td>
                                        <td>{{ loan.duration }} mois</td>
                                        <td>{{ loan.interestRate }}%</td>
                                        <td>
                                            <span class="badge bg-{{ loan.status == 'approved' ? 'success' : (loan.status == 'pending' ? 'warning' : 'danger') }}">
                                                {% if loan.status == 'approved' %}
                                                    <i class="fas fa-check me-1"></i>Approuvé
                                                {% elseif loan.status == 'pending' %}
                                                    <i class="fas fa-clock me-1"></i>En attente
                                                {% else %}
                                                    <i class="fas fa-times me-1"></i>Rejeté
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{{ path('client_loan_detail', {id: loan.id}) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Aucun prêt pour le moment</h5>
                        <p class="text-muted">Commencez par faire une demande de prêt.</p>
                        <a href="{{ path('loan_request') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Nouvelle Demande
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notifications and Quick Actions -->
    <div class="col-lg-4">
        <!-- Recent Notifications -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bell me-2"></i>Notifications Récentes
                </h6>
                <a href="{{ path('client_notifications') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>Tout voir
                </a>
            </div>
            <div class="card-body p-0">
                {% if notifications|length > 0 %}
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                            <div class="list-group-item list-group-item-action {{ not notification.isRead ? 'bg-light' : '' }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ notification.title }}</h6>
                                    <small class="text-muted">{{ notification.createdAt|date('d/m H:i') }}</small>
                                </div>
                                <p class="mb-1">{{ notification.message|slice(0, 80) }}{% if notification.message|length > 80 %}...{% endif %}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Aucune notification</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>Actions Rapides
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ path('loan_request') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Nouvelle Demande de Prêt
                    </a>
                    <a href="{{ path('client_messages') }}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i>Contacter un Conseiller
                    </a>
                    <a href="{{ path('app_calculator') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-calculator me-2"></i>Simulateur de Prêt
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Section -->
{% if loans|length > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>Évolution de vos Demandes
                </h6>
            </div>
            <div class="card-body">
                <canvas id="loansChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Real-time status updates for loans
            function updateLoanStatuses() {
                const loanRows = document.querySelectorAll('[data-loan-id]');
                loanRows.forEach(row => {
                    const loanId = row.dataset.loanId;
                    fetch(`{{ path('api_loan_status', {id: '__ID__'}) }}`.replace('__ID__', loanId))
                        .then(response => response.json())
                        .then(data => {
                            // Update status badge
                            const statusBadge = row.querySelector('.badge');
                            let badgeClass = 'bg-warning';
                            let statusText = '<i class="fas fa-clock me-1"></i>En attente';
                            
                            if (data.status === 'approved') {
                                badgeClass = 'bg-success';
                                statusText = '<i class="fas fa-check me-1"></i>Approuvé';
                            } else if (data.status === 'rejected') {
                                badgeClass = 'bg-danger';
                                statusText = '<i class="fas fa-times me-1"></i>Rejeté';
                            }
                            
                            statusBadge.className = `badge ${badgeClass}`;
                            statusBadge.innerHTML = statusText;
                        })
                        .catch(error => console.error('Erreur lors de la mise à jour du statut:', error));
                });
            }

            // Update loan statuses every 30 seconds
            setInterval(updateLoanStatuses, 30000);

            // Chart initialization
            {% if loans|length > 0 %}
            const ctx = document.getElementById('loansChart').getContext('2d');
            const loansData = {{ loans|map(l => {date: l.createdAt|date('Y-m-d'), amount: l.amount, status: l.status})|json_encode|raw }};
            
            // Process data for chart
            const chartData = {};
            loansData.forEach(loan => {
                const month = loan.date.substring(0, 7); // YYYY-MM
                if (!chartData[month]) {
                    chartData[month] = {approved: 0, pending: 0, rejected: 0, total: 0};
                }
                chartData[month][loan.status]++;
                chartData[month].total++;
            });

            const months = Object.keys(chartData).sort();
            const approvedData = months.map(month => chartData[month].approved);
            const pendingData = months.map(month => chartData[month].pending);
            const rejectedData = months.map(month => chartData[month].rejected);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(month => {
                        const [year, monthNum] = month.split('-');
                        return new Date(year, monthNum - 1).toLocaleDateString('fr-FR', {month: 'short', year: 'numeric'});
                    }),
                    datasets: [{
                        label: 'Approuvés',
                        data: approvedData,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'En attente',
                        data: pendingData,
                        borderColor: 'rgb(234, 179, 8)',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Rejetés',
                        data: rejectedData,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            {% endif %}
        });
    </script>
{% endblock %}